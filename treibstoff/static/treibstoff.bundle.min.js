var ts=function(t,e){"use strict";function s(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}function a(t,e){return t.charAt(t.length-1)===e&&(t=t.substring(0,t.length-1)),t}function r(t){let e=document.createElement("a");e.href=t;let s=e.pathname;return a(t=e.protocol+"//"+e.host+s,"/")}function i(t,e){let s=document.createElement("a");s.href=t;let a=s.search;if(e)return a||"";let r={};if(a){let t=a.substring(1,a.length).split("&");for(let e=0;e<t.length;e++){let s=t[e].split("=");r[s[0]]=s[1]}}return r}function n(t,e){let s=document.createElement("a");s.href=t;let r=a(s.pathname,"/");return e&&(r+=i(t,!0)),r}const o="http://www.w3.org/2000/svg";function l(t,e){for(let s in e)t.setAttributeNS(null,s,e[s])}function h(t,e,s){let a=document.createElementNS(o,t);return l(a,e),void 0!==s&&s.appendChild(a),a}function c(t,e){var s=h("svg",{});s.innerHTML=t.trim();let a=[],r=s.childNodes;for(let t=0;t<r.length;t++){let i=r[t];a.push(i),s.removeChild(i),void 0!==e&&e.appendChild(i)}return a}class _{constructor(t,e,s){this._inst=t,this._name=e,this._val=null,Object.defineProperty(t,e,{get:this.get.bind(this),set:this.set.bind(this),enumerable:!0}),void 0!==s&&(t[e]=s)}get(){return this._val}set(t){let e=t!==this._val;this._val=t,e&&this.trigger(`on_${this._name}`,t)}trigger(t,e){let s=this._inst;s.trigger&&s.trigger(t,e)}}class u extends _{constructor(t,e,s){super(t,e),this._ctxa="elem",s?(this._ctxa=void 0!==s.ctxa?s.ctxa:this._ctxa,this._ctx=void 0!==s.ctx?s.ctx:t[this._ctxa],this._tgt=void 0!==s.tgt?s.tgt:e):(this._ctx=t[this._ctxa],this._tgt=e);let a=s?s.val:void 0;void 0!==a&&(t[e]=a)}get name(){return this._name}get val(){return this._val}get ctx(){return this._ctx||(this._ctx=this._inst[this._ctxa]),this._ctx}get tgt(){return this._tgt}}class d extends u{constructor(t,e,s){super(t,e,s),this.extract=s?s.extract:null,this.state_evt=s&&s.state_evt?s.state_evt:"on_prop_state",this.error=!1,this.msg="",this._err_marker={},this.ctx.on("change",this._change.bind(this))}set(t){e(this.ctx).val(t),this._set(t)}_change(t){let s=e(t.currentTarget).val();this._set(s)}_set(t){(t=this._extract(t))!==this._err_marker&&super.set(t),this.extract&&this.trigger(this.state_evt,this)}_extract(t){if(this.extract)try{t=this.extract(t),this.error=!1,this.msg=""}catch(e){t=this._err_marker,this.error=!0,this.msg=e}return t}}class p extends u{constructor(t,e,s){super(t,e,s),this.ctx.on("mousedown",this._down.bind(this)),this.ctx.on("mouseup",this._up.bind(this)),this.ctx.on("click",this._click.bind(this))}set(t){this.ctx.text(t),super.set(t)}_down(t){this.trigger(`on_${this.name}_down`,this)}_up(t){this.trigger(`on_${this.name}_up`,this)}_click(t){this.trigger(`on_${this.name}_click`,this)}}class f{walk(t){let e=t.childNodes;for(let t of e)this.walk(t);t.nodeType===Node.ELEMENT_NODE&&this.parse(t)}parse(t){}node_attrs(t){let e={};for(let s of t.attributes)s&&s.nodeName&&(e[s.nodeName]=s.nodeValue);return e}}class m extends f{constructor(t){super(),this.widget=t,this.handlers={}}parse(t){let e=this.node_attrs(t),s=this.wrap_node(t);this.handle_elem_attr(s,e);let a=t.tagName.toLowerCase(),r=this.handlers[a];r&&r(s,e)}wrap_node(t){return t}handle_elem_attr(t,e){let s=e["t-elem"];s&&(this.widget[s]=t)}}function g(t){if(isNaN(t))throw"Input is not a number";return Number(t)}class x extends m{constructor(t){super(t),this.handlers={input:this.handle_input.bind(this),select:this.handle_select.bind(this),button:this.handle_button.bind(this)},this.extractors={number:g}}wrap_node(t){return e(t)}handle_input(t,e){let s=e["t-prop"];if(!s)return;let a=this.widget,r=this.extractors[e["t-type"]];e["t-extract"]&&(r=a[e["t-extract"]]);let i=e["t-val"];r&&(i=r(i)),new d(a,s,{ctx:t,ctxa:e["t-elem"],val:i,extract:r,state_evt:e["t-state-evt"]})}handle_select(t,e){let s=e["t-options"];if(s)for(let e of JSON.parse(s))t.append(`<option value="${e[0]}">${e[1]}</option>`);this.handle_input(t,e)}handle_button(t,e){let s=e["t-prop"];if(!s)return;let a=this.widget;new p(a,s,{ctx:t,ctxa:e["t-elem"],val:e["t-val"]});for(let t of["down","up","click"])if(e[`t-bind-${t}`]){let r=a[e[`t-bind-${t}`]].bind(a);this.widget.on(`on_${s}_${t}`,r)}}}function v(t,s,a){let r=e(s.trim());a&&a.append(r);let i=new x(t);return r.each((function(){i.walk(this)})),r}class b extends m{}class j{constructor(){this._subscribers={},this._suppress_events=!1}on(t,e){let s=this._subscribers[t];return void 0===s&&(this._subscribers[t]=s=new Array),this._contains_subscriber(t,e)||s.push(e),this}off(t,e){let s=this._subscribers[t];if(void 0===s)return this;if(!e)return delete this._subscribers[t],this;let a=s.indexOf(e);return a>-1&&(s=s.splice(a,1)),this._subscribers[t]=s,this}trigger(t,e){if(this._suppress_events)return;this[t]&&this[t](e);let s=this._subscribers[t];if(!s)return this;for(let t=0;t<s.length;t++)s[t](this,e);return this}suppress_events(t){this._suppress_events=!0,t(),this._suppress_events=!1}bind_from_options(t,e){for(let s of t)e[s]&&this.on(s,e[s])}_contains_subscriber(t,e){let s=this._subscribers[t];if(!s)return!1;for(let t=0;t<s.length;t++)if(s[t]===e)return!0;return!1}}class y extends j{constructor(t){super(),this.uid=t.uid?t.uid:s(),this.css=t.css?t.css:"",this.title=t.title?t.title:"&nbsp;",this.content=t.content?t.content:"",this.bind_from_options(["on_open","on_close"],t),this.container=t.container?t.container:e("body"),this.compile(),this.elem.data("overlay",this)}compile(){v(this,`\n          <div class="modal ${this.css}" id="${this.uid}" t-elem="elem">\n            <div class="modal-dialog">\n              <div class="modal-content">\n                <div class="modal-header">\n                  <button class="close" t-prop="close_btn" t-bind-click="close">\n                    <span aria-hidden="true">&times;</span>\n                    <span class="sr-only">Close</span>\n                  </button>\n                  <h5 class="modal-title">${this.title}</h5>\n                </div>\n                <div class="modal-body" t-elem="body">${this.content}</div>\n                <div class="modal-footer" t-elem="footer"></div>\n              </div>\n            </div>\n          </div>\n        `)}open(){e("body").css("padding-right","13px").css("overflow-x","hidden").addClass("modal-open"),this.container.append(this.elem),this.elem.show(),this.trigger("on_open")}close(){1===e(".modal:visible").length&&e("body").css("padding-right","").css("overflow-x","auto").removeClass("modal-open"),this.elem.remove(),this.trigger("on_close")}}class w extends y{constructor(t){t.content=t.message?t.message:t.content,t.css=t.flavor?t.flavor:t.css,super(t),this.compile_actions()}compile_actions(){v(this,'\n          <button class="close btn btn-default allowMultiSubmit"\n                  t-prop="f_close_btn" t-bind-click="close">Close</button>\n        ',this.footer)}}class k extends w{constructor(t){super(t),this.bind_from_options(["on_confirm"],t)}compile_actions(){v(this,'\n          <button class="submit btn btn-default allowMultiSubmit"\n                  t-prop="ok_btn">OK</button>\n          <button class="cancel btn btn-default allowMultiSubmit"\n                  t-prop="cancel_btn" t-bind-click="close">Cancel</button>\n        ',this.footer)}on_ok_btn_click(){this.close(),this.trigger("on_confirm")}}class q{constructor(){this._request_count=0,this.icon_source="/treibstoff-static/loading-spokes.svg",this.compile()}compile(){v(this,`\n          <div id="ajax-spinner" t-elem="elem">\n            <img src="${this.icon_source}" width="64" height="64" alt="" />\n          </div>\n        `)}show(){this._request_count++,this._request_count>1||e("body").append(this.elem)}hide(t){if(this._request_count--,t)return this._request_count=0,void this.elem.remove();this._request_count<=0&&(this._request_count=0,this.elem.remove())}}class P{constructor(){this.default_403="/login",this.overlay_content_selector=".modal-body",this.binders={},this.spinner=new q,this._afr=null,e(window).on("popstate",this._history_handle.bind(this))}register(t,e){let a="binder_"+s();for(;void 0!==this.binders[a];)a="binder_"+s();this.binders[a]=t,e&&t()}parseurl(t){return console.log("ts.ajax.parseurl is deprecated. use ts.parse_url"),r(t)}parsequery(t,e){return console.log("ts.ajax.parsequery is deprecated. use ts.parse_query"),i(t,e)}parsepath(t,e){return console.log("ts.ajax.parsepath is deprecated. use ts.parse_path"),n(t,e)}parsetarget(t){return console.log("ts.ajax.parsetarget is deprecated. use ts.ajax.parse_target"),this.parse_target(t)}parse_target(t){if(!t)return{url:void 0,params:{},path:void 0,query:void 0};let e=r(t),s=i(t);return s||(s={}),{url:e,params:s,path:n(t),query:i(t,!0)}}request(t){if(-1!==t.url.indexOf("?")){let e=t.params;t.params=i(t.url),t.url=r(t.url);for(let s in e)t.params[s]=e[s]}else t.params||(t.params={});t.type||(t.type="html"),t.method||(t.method="GET"),t.error||(t.error=function(t,e,s){if(403===parseInt(e,10))window.location.hash="",window.location.pathname=this.default_403;else{let t="<strong>"+e+"</strong> ";t+=s,this.error(t)}}.bind(this)),t.cache||(t.cache=!1);let s=function(e,s,a){t.success(e,s,a),this.spinner.hide()}.bind(this),a=function(e,s,a){0!==e.status?(s=e.status||s,a=e.statusText||a,t.error(e,s,a),this.spinner.hide(!0)):this.spinner.hide(!0)}.bind(this);this.spinner.show(),e.ajax({url:t.url,dataType:t.type,data:t.params,method:t.method,success:s,error:a,cache:t.cache})}path(t){if(void 0===window.history.pushState)return;"/"!==t.path.charAt(0)&&(t.path="/"+t.path),t.target||(t.target=window.location.origin+t.path);let e={target:t.target,action:t.action,event:t.event,overlay:t.overlay,overlay_css:t.overlay_css};t.replace?window.history.replaceState(e,"",t.path):window.history.pushState(e,"",t.path)}action(t){t.success=this._finish_ajax_action.bind(this),this._request_ajax_action(t)}trigger(t,s,a,r){let i=function(){let s=e.Event(t);return a.url?s.ajaxtarget=a:s.ajaxtarget=this.parse_target(a),s.ajaxdata=r,s}.bind(this);e(s).each((function(){e(this).trigger(i())}))}overlay(t){if(t.close){let s=e("#"+t.uid).data("overlay");return void(s&&s.close())}let a,r;if(t.target){let e=t.target;e.url||(e=this.parse_target(e)),a=e.url,r=e.params}else a=t.url,r=t.params;let i=t.uid?t.uid:s();r["ajax.overlay-uid"]=i;let n="#"+i+" "+this.overlay_content_selector;return this._request_ajax_action({name:t.action,selector:n,mode:"inner",url:a,params:r,success:function(e){e.payload?(new y({uid:i,css:t.css,title:t.title,on_close:function(){t.on_close&&t.on_close()}}).open(),this._finish_ajax_action(e)):this._finish_ajax_action(e)}.bind(this)}),i}message(t,s=""){new w({title:"Message",message:t,flavor:s,on_open:function(t){e("button",t.elem).first().focus()}}).open()}error(t){this.message(t,"error")}info(t){this.message(t,"info")}warning(t){this.message(t,"warning")}dialog(t,e){new k({title:"Dialog",message:t.message,on_confirm:function(){e(t)}}).open()}bind_dispatcher(t,s){e(t).off(s).on(s,this._dispatch_handle.bind(this))}bind_ajax_form(t){let s=e("form.ajax",t);s.length&&console.log("B/C AJAX form found. Please use ``ajax:form`` attribute instead of ``ajax`` CSS class."),this.prepare_ajax_form(s)}prepare_ajax_form(t){this._afr||v(this,'\n              <iframe t-elem="_afr" id="ajaxformresponse"\n                      name="ajaxformresponse" src="about:blank"\n                      style="width:0px;height:0px;display:none">\n              </iframe>\n            ',e("body")),t.append('<input type="hidden" name="ajax" value="1" />'),t.attr("target","ajaxformresponse"),t.off().on("submit",function(t){this.spinner.show()}.bind(this))}render_ajax_form(t){this.spinner.hide(),t.error||(this._afr.remove(),this._afr=null),t.payload&&this._fiddle(t.payload,t.selector,t.mode),this._continuation(t.next)}call_binders(t){for(let e in this.binders)try{this.binders[e](t)}catch(t){console.log(t)}}_fiddle(t,s,a){if("replace"===a){e(s).replaceWith(t);let a=e(s);a.length?a.parent().tsajax():e(document).tsajax()}else"inner"===a&&(e(s).html(t),e(s).tsajax())}_continuation(t){if(t){this.spinner.hide();for(let s of t){let t=s.type;if(delete s.type,"path"===t)this.path(s);else if("action"===t){let t=this.parse_target(s.target);s.url=t.url,s.params=t.params,this.action(s)}else if("event"===t)this.trigger(s.name,s.selector,s.target,s.data);else if("overlay"===t){let t=this.parse_target(s.target);s.url=t.url,s.params=t.params,this.overlay(s)}else if("message"===t)if(s.flavor){if(-1===["message","info","warning","error"].indexOf(s.flavor))throw"Continuation definition.flavor unknown";this[s.flavor](s.payload)}else{if(!s.selector)throw"Continuation definition.selector expected";e(s.selector).html(s.payload)}}}}_history_handle(t){t.preventDefault();let e,s=t.originalEvent.state;s&&(e=s.target.url?s.target:this.parse_target(s.target),e.params.popstate="1",s.action&&this._ajax_action(e,s.action),s.event&&this._ajax_event(e,s.event),s.overlay&&this._ajax_overlay(e,s.overlay,s.overlay_css),s.action||s.event||s.overlay||(window.location=e.url))}_dispatch_handle(t){t.preventDefault(),t.stopPropagation();let s=e(t.currentTarget),a={elem:s,event:t};s.attr("ajax:confirm")?(a.message=s.attr("ajax:confirm"),this.dialog(a,this._dispatch.bind(this))):this._dispatch(a)}_get_target(t,e){return e.ajaxtarget?e.ajaxtarget:this.parse_target(t.attr("ajax:target"))}_dispatch(t){let e=t.elem,s=t.event;e.attr("ajax:action")&&this._ajax_action(this._get_target(e,s),e.attr("ajax:action")),e.attr("ajax:event")&&this._ajax_event(e.attr("ajax:target"),e.attr("ajax:event")),e.attr("ajax:overlay")&&this._ajax_overlay(this._get_target(e,s),e.attr("ajax:overlay"),e.attr("ajax:overlay-css")),e.attr("ajax:path")&&this._ajax_path(e,s)}_has_attr(t,e){let s=t.attr(e);return void 0!==s&&!1!==s}_attr_val_or_default(t,e,s){return this._has_attr(t,e)?t.attr(e):t.attr(s)}_ajax_path(t,e){let s,a=t.attr("ajax:path");if("href"===a){a=n(t.attr("href"),!0)}else if("target"===a){let s=this._get_target(t,e);a=s.path+s.query}this._has_attr(t,"ajax:path-target")?(s=t.attr("ajax:path-target"),s&&(s=this.parse_target(s))):s=this._get_target(t,e);let r=this._attr_val_or_default(t,"ajax:path-action","ajax:action"),i=this._attr_val_or_default(t,"ajax:path-event","ajax:event"),o=this._attr_val_or_default(t,"ajax:path-overlay","ajax:overlay"),l=this._attr_val_or_default(t,"ajax:path-overlay-css","ajax:overlay-css");this.path({path:a,target:s,action:r,event:i,overlay:o,overlay_css:l})}_ajax_event(t,e){let s=this._defs_to_array(e);for(let e=0;e<s.length;e++){let a=s[e];a=a.split(":"),this.trigger(a[0],a[1],t)}}_request_ajax_action(t){t.params["ajax.action"]=t.name,t.params["ajax.mode"]=t.mode,t.params["ajax.selector"]=t.selector,this.request({url:r(t.url)+"/ajaxaction",type:"json",params:t.params,success:t.success})}_finish_ajax_action(t){t?(this._fiddle(t.payload,t.selector,t.mode),this._continuation(t.continuation)):(this.error("Empty response"),this.spinner.hide())}_ajax_action(t,e){let s=this._defs_to_array(e);for(let e=0;e<s.length;e++){let a=s[e].split(":");this.action({name:a[0],selector:a[1],mode:a[2],url:t.url,params:t.params})}}_ajax_overlay(t,e,s){if(e.indexOf("CLOSE")>-1){let t={};return e.indexOf(":")>-1&&(t.selector=e.split(":")[1]),t.close=!0,void this.overlay(t)}if(e.indexOf(":")>-1){let a=e.split(":"),r={action:a[0],selector:a[1],url:t.url,params:t.params,css:s};return 3===a.length&&(r.content_selector=a[2]),void this.overlay(r)}this.overlay({action:e,url:t.url,params:t.params,css:s})}_defs_to_array(t){return t.replace(/\s+/g," ").split(" ")}}let S=new P;class C extends f{constructor(t){super(),this.ajax=t}parse(t){let s=this.node_attrs(t);if(s["ajax:bind"]&&(s["ajax:action"]||s["ajax:event"]||s["ajax:overlay"])){let e=s["ajax:bind"];this.ajax.bind_dispatcher(t,e)}s["ajax:form"]&&this.ajax.prepare_ajax_form(e(t))}}function E(t){let e=new C(S);return t.each((function(){e.walk(this)})),S.bind_ajax_form(t),S.call_binders(t),t}e.fn.tsajax=function(){E(this)},e((function(){S.spinner.hide(),e(document).tsajax()})),t.Ajax=P,t.AjaxParser=C,t.AjaxSpinner=q,t.AttrProperty=class extends u{set(t){this.ctx.attr(this.tgt,t),super.set(t)}},t.BoundProperty=u,t.ButtonProperty=p,t.CSSProperty=class extends u{set(t){e(this.ctx).css(this.tgt,t),super.set(t)}},t.DataProperty=class extends u{constructor(t,e,s){s?s.ctx=void 0!==s.ctx?s.ctx:t.data:s={ctx:t.data},s.ctxa="data",super(t,e,s)}set(t){this.ctx[this.tgt]=t,super.set(t)}},t.Dialog=k,t.Events=j,t.HTMLParser=x,t.InputProperty=d,t.Message=w,t.Overlay=y,t.Parser=f,t.Property=_,t.SVGParser=b,t.SVGProperty=class extends u{set(t){let e={};e[this._name]=t,l(this.ctx,e),super.set(t)}},t.TemplateParser=m,t.TextProperty=class extends u{set(t){this.ctx.text(t),super.set(t)}},t.ajax=S,t.compile_svg=function(t,e,s){let a=c(e,s),r=new b(t);return a.forEach((function(t,e){r.walk(t)})),a},t.compile_template=v,t.create_svg_elem=h,t.extract_number=g,t.json_merge=function(t,e){let s={};for(let a of[t,e])for(let t in a)s[t]=a[t];return s},t.load_svg=function(t,s){e.get(t,function(t){let a=e(t).find("svg");a.removeAttr("xmlns:a"),s(a)}.bind(this),"xml")},t.parse_ajax=E,t.parse_path=n,t.parse_query=i,t.parse_svg=c,t.parse_url=r,t.set_svg_attrs=l,t.svg_ns=o,t.uuid4=s,Object.defineProperty(t,"__esModule",{value:!0});var $=window.ts;return t.noConflict=function(){return window.ts=$,this},window.ts=t,window.bdajax=t.ajax,e.fn.bdajax=e.fn.tsajax,t}({},jQuery);
//# sourceMappingURL=treibstoff.bundle.min.js.map
